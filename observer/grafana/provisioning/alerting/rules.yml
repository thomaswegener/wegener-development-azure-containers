apiVersion: 1

groups:
  - orgId: 1
    name: System health
    folder: System
    interval: 1m
    rules:
      - uid: node-up
        title: Node up (node_exporter)
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 120
              to: 0
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: up{job="node_exporter"} == 0
              interval: ""
              legendFormat: "{{instance}}"
              refId: A
            queryType: instant
        noDataState: OK
        execErrState: Error
        for: 1m

      - uid: disk-free-low
        title: Disk almost full (<10% free)
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 120
              to: 0
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.10
              interval: ""
              legendFormat: "{{instance}} {{device}}"
              refId: A
            queryType: instant
        noDataState: OK
        execErrState: Error
        for: 2m

      - uid: high-load
        title: HÃ¸y belastning (>1.5 per kjerne)
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 120
              to: 0
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: (node_load1 / count without(cpu, mode) (node_cpu_seconds_total{mode="idle"})) > 1.5
              interval: ""
              legendFormat: "{{instance}}"
              refId: A
            queryType: instant
        noDataState: OK
        execErrState: Error
        for: 2m

  - orgId: 1
    name: Security
    folder: Security
    interval: 1m
    rules:
      - uid: ssh-successful-login
        title: SSH successful login detected
        condition: A
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 120
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              expr: 'sum(count_over_time({job="auth"} |~ "Accepted (password|publickey)" [2m]))'
              interval: ""
              refId: A
            queryType: instant
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          summary: "Successful SSH login detected. Check Observer - Security dashboard for details."

      - uid: ssh-brute-force
        title: SSH brute force attack (>30 attempts/2m)
        condition: A
        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 120
              to: 0
            model:
              datasource:
                type: loki
                uid: loki
              expr: 'sum(count_over_time({job="auth"} |~ "Invalid user|Failed password" [2m])) > 30'
              interval: ""
              refId: A
            queryType: instant
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          summary: "High rate of failed SSH login attempts detected (>30 in 2 minutes)."
