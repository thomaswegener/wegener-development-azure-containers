generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id          String      @id @default(uuid())
  email       String      @unique
  displayName String?
  avatarUrl   String?
  role        UserRole    @default(USER)
  createdAt   DateTime    @default(now())
  sessions    Session[]
  appAccess   AppAccess[]
  magicLinks  MagicLink[]
  identities  Identity[]
}

model Identity {
  id         String @id @default(uuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider   String
  providerId String

  @@unique([provider, providerId])
}

model AppAccess {
  id       String  @id @default(uuid())
  userId   String
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  appId    String
  role     String
  metadata Json?

  @@unique([userId, appId])
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  expiresAt  DateTime
  ip         String?
  userAgent  String?
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())
}

model MagicLink {
  id        String    @id @default(uuid())
  userId    String?
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  email     String
  tokenHash String    @unique
  redirect  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
}
